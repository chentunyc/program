# è™šæ‹Ÿä»¿çœŸå®è®­æ•™å­¦ç®¡ç†å¹³å° - å…³é”®ä»£ç è¯¦è§£

> æœ¬æ–‡æ¡£æ·±å…¥è®²è§£é¡¹ç›®ä¸­çš„å…³é”®ä»£ç å®ç°ï¼ŒåŒ…æ‹¬è®¾è®¡æ€æƒ³ã€æŠ€æœ¯ç»†èŠ‚å’Œæœ€ä½³å®è·µ

---

## ğŸ“‹ ç›®å½•

1. [ç»Ÿä¸€å“åº”å°è£…](#1-ç»Ÿä¸€å“åº”å°è£…)
2. [JWTè®¤è¯æœºåˆ¶è¯¦è§£](#2-jwtè®¤è¯æœºåˆ¶è¯¦è§£)
3. [èµ„æºå¤šç±»å‹ç®¡ç†å®ç°](#3-èµ„æºå¤šç±»å‹ç®¡ç†å®ç°)
4. [MyBatis-Plusé«˜çº§ç”¨æ³•](#4-mybatis-plusé«˜çº§ç”¨æ³•)
5. [å‰ç«¯è¯·æ±‚æ‹¦æˆªå™¨è¯¦è§£](#5-å‰ç«¯è¯·æ±‚æ‹¦æˆªå™¨è¯¦è§£)
6. [æƒé™æ§åˆ¶å®ç°](#6-æƒé™æ§åˆ¶å®ç°)
7. [åˆ†é¡µæŸ¥è¯¢æœ€ä½³å®è·µ](#7-åˆ†é¡µæŸ¥è¯¢æœ€ä½³å®è·µ)
8. [äº‹åŠ¡ç®¡ç†å’Œå¼‚å¸¸å¤„ç†](#8-äº‹åŠ¡ç®¡ç†å’Œå¼‚å¸¸å¤„ç†)

---

## 1. ç»Ÿä¸€å“åº”å°è£…

### 1.1 Resultç±»è®¾è®¡

**æ–‡ä»¶ä½ç½®**: `backend/src/main/java/com/training/common/base/Result.java`

**å®Œæ•´ä»£ç **:

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)  // ç©ºå€¼ä¸åºåˆ—åŒ–
public class Result<T> implements Serializable {

    private Integer code;      // å“åº”ç 
    private String message;    // å“åº”æ¶ˆæ¯
    private T data;           // å“åº”æ•°æ®ï¼ˆæ³›å‹ï¼‰
    private Long timestamp;   // æ—¶é—´æˆ³

    /**
     * æˆåŠŸå“åº”(æ— æ•°æ®)
     */
    public static <T> Result<T> success() {
        return new Result<>(200, "æ“ä½œæˆåŠŸ", null, System.currentTimeMillis());
    }

    /**
     * æˆåŠŸå“åº”(å¸¦æ•°æ®)
     */
    public static <T> Result<T> success(T data) {
        return new Result<>(200, "æ“ä½œæˆåŠŸ", data, System.currentTimeMillis());
    }

    /**
     * å¤±è´¥å“åº”(è‡ªå®šä¹‰æ¶ˆæ¯)
     */
    public static <T> Result<T> error(String message) {
        return new Result<>(500, message, null, System.currentTimeMillis());
    }
}
```

### 1.2 è®¾è®¡è¦ç‚¹è¯¦è§£

**1. æ³›å‹è®¾è®¡**:
```java
public class Result<T>
```
- **ä¼˜åŠ¿**: æ”¯æŒä»»æ„ç±»å‹æ•°æ®ï¼Œç±»å‹å®‰å…¨
- **åº”ç”¨**: `Result<UserVO>`, `Result<List<NewsVO>>`, `Result<Void>`

**2. é™æ€å·¥å‚æ–¹æ³•**:
```java
public static <T> Result<T> success(T data)
```
- **ä¼˜åŠ¿**:
  - æ¯”æ„é€ å‡½æ•°æ›´æ¸…æ™°è¡¨è¾¾æ„å›¾
  - æ”¯æŒç±»å‹æ¨å¯¼ï¼Œæ— éœ€æ˜¾å¼æŒ‡å®šæ³›å‹
  - ç»Ÿä¸€å“åº”æ ¼å¼ï¼Œé¿å…å¼€å‘è€…éšæ„æ„é€ 

**ä½¿ç”¨ç¤ºä¾‹**:
```java
// âœ… æ¨èï¼šç±»å‹è‡ªåŠ¨æ¨å¯¼
return Result.success(userVO);

// âŒ ä¸æ¨èï¼šéœ€è¦æ˜¾å¼æŒ‡å®šç±»å‹
return new Result<UserVO>(200, "æˆåŠŸ", userVO, timestamp);
```

**3. JsonIncludeæ³¨è§£**:
```java
@JsonInclude(JsonInclude.Include.NON_NULL)
```
- **ä½œç”¨**: ç©ºå€¼å­—æ®µä¸å‚ä¸JSONåºåˆ—åŒ–
- **å¥½å¤„**: å‡å°‘ä¼ è¾“æ•°æ®é‡ï¼Œå‰ç«¯æ— éœ€å¤„ç†nullå€¼

**åºåˆ—åŒ–å¯¹æ¯”**:
```java
// æœ‰æ•°æ®æ—¶
{"code":200,"message":"æˆåŠŸ","data":{...},"timestamp":1234567890}

// æ— æ•°æ®æ—¶ï¼ˆçœç•¥äº†dataå­—æ®µï¼‰
{"code":200,"message":"æˆåŠŸ","timestamp":1234567890}
```

**4. å“åº”ç è§„èŒƒ**:
```
200 - æˆåŠŸ
400 - å®¢æˆ·ç«¯é”™è¯¯ï¼ˆå‚æ•°æ ¡éªŒå¤±è´¥ï¼‰
401 - æœªæˆæƒï¼ˆTokenå¤±æ•ˆï¼‰
403 - æƒé™ä¸è¶³
404 - èµ„æºä¸å­˜åœ¨
500 - æœåŠ¡å™¨é”™è¯¯
```

---

## 2. JWTè®¤è¯æœºåˆ¶è¯¦è§£

### 2.1 JwtUtilså·¥å…·ç±»æ ¸å¿ƒä»£ç 

**æ–‡ä»¶ä½ç½®**: `backend/src/main/java/com/training/common/utils/JwtUtils.java`

**å…³é”®ä»£ç 1ï¼šç”ŸæˆToken**

```java
public String generateToken(Map<String, Object> claims) {
    Date now = new Date();
    Date expiryDate = new Date(now.getTime() + expiration * 1000);

    return Jwts.builder()
            .claims(claims)              // â‘  è‡ªå®šä¹‰å£°æ˜
            .issuedAt(now)               // â‘¡ ç­¾å‘æ—¶é—´
            .expiration(expiryDate)      // â‘¢ è¿‡æœŸæ—¶é—´
            .signWith(getSecretKey())    // â‘£ ä½¿ç”¨å¯†é’¥ç­¾å
            .compact();                  // â‘¤ ç”ŸæˆJWTå­—ç¬¦ä¸²
}

private SecretKey getSecretKey() {
    // å°†å­—ç¬¦ä¸²å¯†é’¥è½¬æ¢ä¸ºSecretKeyå¯¹è±¡
    return Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));
}
```

**æŠ€æœ¯ç»†èŠ‚**:

**â‘  Claimsï¼ˆå£°æ˜ï¼‰**:
```java
Map<String, Object> claims = new HashMap<>();
claims.put("userId", 1001L);
claims.put("username", "zhangsan");
```
- JWT Payloadéƒ¨åˆ†å­˜å‚¨çš„è‡ªå®šä¹‰æ•°æ®
- æ”¯æŒä»»æ„é”®å€¼å¯¹
- **æ³¨æ„**: ä¸è¦å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰ï¼ŒJWTå¯è¢«è§£ç 

**â‘¡ IssuedAtï¼ˆç­¾å‘æ—¶é—´ï¼‰**:
```java
.issuedAt(now)
```
- è®°å½•Tokenåˆ›å»ºæ—¶é—´
- ç”¨äºåˆ¤æ–­Tokenæœ‰æ•ˆæœŸ

**â‘¢ Expirationï¼ˆè¿‡æœŸæ—¶é—´ï¼‰**:
```java
Date expiryDate = new Date(now.getTime() + expiration * 1000);
.expiration(expiryDate)
```
- è®¡ç®—æ–¹å¼ï¼šå½“å‰æ—¶é—´ + é…ç½®çš„è¿‡æœŸç§’æ•°
- ç¤ºä¾‹ï¼š7200ç§’ = 2å°æ—¶

**â‘£ SignWithï¼ˆç­¾åï¼‰**:
```java
.signWith(getSecretKey())
```
- ä½¿ç”¨HMAC-SHA256ç®—æ³•ç­¾å
- å¯†é’¥é•¿åº¦è¦æ±‚ï¼šè‡³å°‘256ä½ï¼ˆ32å­—èŠ‚ï¼‰
- **å®‰å…¨æ€§**: å³ä½¿Payloadè¢«è§£ç ï¼Œä¹Ÿæ— æ³•ä¼ªé€ ç­¾å

**JWTç»“æ„ç¤ºä¾‹**:
```
Headerï¼ˆå¤´éƒ¨ï¼‰:
{
  "alg": "HS256",
  "typ": "JWT"
}

Payloadï¼ˆè´Ÿè½½ï¼‰:
{
  "userId": 1001,
  "username": "zhangsan",
  "iat": 1609459200,
  "exp": 1609466400
}

Signatureï¼ˆç­¾åï¼‰:
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret
)

æœ€ç»ˆToken:
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEwMDEsInVzZXJuYW1lIjoiemhhbmdzYW4iLCJpYXQiOjE2MDk0NTkyMDAsImV4cCI6MTYwOTQ2NjQwMH0.xxx
```

**å…³é”®ä»£ç 2ï¼šéªŒè¯Token**

```java
public boolean validateToken(String token) {
    try {
        // è§£æToken
        Claims claims = getClaimsFromToken(token);
        if (claims == null) {
            return false;
        }

        // æ£€æŸ¥è¿‡æœŸæ—¶é—´
        Date expiration = claims.getExpiration();
        return expiration != null && expiration.after(new Date());
    } catch (Exception e) {
        log.error("TokenéªŒè¯å¤±è´¥: {}", e.getMessage());
        return false;
    }
}

public Claims getClaimsFromToken(String token) {
    try {
        return Jwts.parser()
                .verifyWith(getSecretKey())  // è®¾ç½®å¯†é’¥
                .build()
                .parseSignedClaims(token)    // è§£æå¹¶éªŒè¯ç­¾å
                .getPayload();               // è·å–Payload
    } catch (Exception e) {
        log.error("è§£æTokenå¤±è´¥: {}", e.getMessage());
        return null;
    }
}
```

**éªŒè¯æµç¨‹**:
```
1. è§£æToken
   â†“
2. éªŒè¯ç­¾åï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰
   â†“
3. æ£€æŸ¥è¿‡æœŸæ—¶é—´
   â†“
4. è¿”å›éªŒè¯ç»“æœ
```

**å¸¸è§å¼‚å¸¸**:
- `SignatureException`: ç­¾åéªŒè¯å¤±è´¥ï¼ˆTokenè¢«ç¯¡æ”¹ï¼‰
- `ExpiredJwtException`: Tokenå·²è¿‡æœŸ
- `MalformedJwtException`: Tokenæ ¼å¼é”™è¯¯

### 2.2 JWTè®¤è¯è¿‡æ»¤å™¨

**æ–‡ä»¶ä½ç½®**: `backend/src/main/java/com/training/common/config/JwtAuthenticationFilter.java`

**æ ¸å¿ƒé€»è¾‘**:

```java
@Override
protected void doFilterInternal(
        HttpServletRequest request,
        HttpServletResponse response,
        FilterChain filterChain) throws ServletException, IOException {

    // 1. ä»è¯·æ±‚å¤´è·å–Token
    String token = getTokenFromRequest(request);

    // 2. éªŒè¯Token
    if (token != null && jwtUtils.validateToken(token)) {
        // 3. ä»Redisè·å–ç”¨æˆ·ä¿¡æ¯
        String redisKey = CommonConstant.LOGIN_USER_KEY + token;
        LoginUser loginUser = redisUtils.get(redisKey);

        if (loginUser != null) {
            // 4. åˆ›å»ºè®¤è¯å¯¹è±¡
            UsernamePasswordAuthenticationToken authentication =
                new UsernamePasswordAuthenticationToken(
                    loginUser,                  // ä¸»ä½“ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
                    null,                       // å‡­è¯ï¼ˆä¸éœ€è¦å¯†ç ï¼‰
                    loginUser.getAuthorities()  // æƒé™åˆ—è¡¨
                );

            // 5. è®¾ç½®åˆ°SecurityContext
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
    }

    // 6. ç»§ç»­è¿‡æ»¤å™¨é“¾
    filterChain.doFilter(request, response);
}

/**
 * ä»è¯·æ±‚å¤´æå–Token
 */
private String getTokenFromRequest(HttpServletRequest request) {
    String bearerToken = request.getHeader(jwtUtils.getHeader());
    if (StringUtils.hasText(bearerToken) && bearerToken.startsWith(jwtUtils.getPrefix())) {
        return bearerToken.substring(jwtUtils.getPrefix().length());
    }
    return null;
}
```

**æŠ€æœ¯è¦ç‚¹**:

**1. è¿‡æ»¤å™¨æ‰§è¡Œæ—¶æœº**:
```java
// SecurityConfig.java
.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
```
- JWTè¿‡æ»¤å™¨åœ¨æ ‡å‡†è®¤è¯è¿‡æ»¤å™¨**ä¹‹å‰**æ‰§è¡Œ
- å…ˆéªŒè¯Tokenï¼Œå†å†³å®šæ˜¯å¦å…è®¸è®¿é—®

**2. åŒé‡éªŒè¯æœºåˆ¶**:
```
JWTéªŒè¯ï¼ˆTokenæœ¬èº«æ˜¯å¦æœ‰æ•ˆï¼‰
    â†“
RediséªŒè¯ï¼ˆä¼šè¯æ˜¯å¦å­˜åœ¨ï¼‰
    â†“
å…è®¸è®¿é—®
```
- **ä¼˜åŠ¿**: å³ä½¿JWTæœªè¿‡æœŸï¼Œä¹Ÿå¯é€šè¿‡åˆ é™¤Redisè®°å½•ç«‹å³å¤±æ•ˆ
- **åº”ç”¨**: ç”¨æˆ·ç™»å‡ºã€å¼ºåˆ¶ä¸‹çº¿ã€ä¿®æ”¹å¯†ç å

**3. SecurityContextä½œç”¨**:
```java
SecurityContextHolder.getContext().setAuthentication(authentication);
```
- å°†è®¤è¯ä¿¡æ¯å­˜å‚¨åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡
- åç»­å¯é€šè¿‡`SecurityUtils.getLoginUser()`è·å–
- è¯·æ±‚ç»“æŸåè‡ªåŠ¨æ¸…é™¤

**4. æƒé™åŠ è½½**:
```java
loginUser.getAuthorities()
```
- `LoginUser`å®ç°`UserDetails`æ¥å£
- `getAuthorities()`è¿”å›ç”¨æˆ·çš„è§’è‰²å’Œæƒé™åˆ—è¡¨
- Spring Securityæ ¹æ®æ­¤åˆ—è¡¨è¿›è¡Œæƒé™åˆ¤æ–­

**LoginUserç±»ç¤ºä¾‹**:
```java
public class LoginUser implements UserDetails {
    private Long userId;
    private String username;
    private String token;
    private List<String> roles;
    private List<String> permissions;

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        // å°†è§’è‰²å’Œæƒé™è½¬æ¢ä¸ºGrantedAuthority
        Set<GrantedAuthority> authorities = new HashSet<>();

        // æ·»åŠ è§’è‰²ï¼ˆä»¥ROLE_å‰ç¼€æ ‡è¯†ï¼‰
        roles.forEach(role -> authorities.add(new SimpleGrantedAuthority(role)));

        // æ·»åŠ æƒé™
        permissions.forEach(permission -> authorities.add(new SimpleGrantedAuthority(permission)));

        return authorities;
    }
}
```

### 2.3 ç™»å½•æµç¨‹å®Œæ•´è§£æ

```java
// AuthServiceImpl.java
@Override
public LoginVO login(LoginRequest loginRequest) {
    // æ­¥éª¤1: åˆ›å»ºè®¤è¯Token
    UsernamePasswordAuthenticationToken authenticationToken =
        new UsernamePasswordAuthenticationToken(
            loginRequest.getUsername(),
            loginRequest.getPassword()
        );

    // æ­¥éª¤2: å§”æ‰˜Spring Securityè®¤è¯
    Authentication authentication;
    try {
        authentication = authenticationManager.authenticate(authenticationToken);
    } catch (Exception e) {
        throw new BusinessException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }

    // æ­¥éª¤3: è·å–è®¤è¯ç”¨æˆ·ä¿¡æ¯
    LoginUser loginUser = (LoginUser) authentication.getPrincipal();

    // æ­¥éª¤4: ç”ŸæˆJWT Token
    Map<String, Object> claims = new HashMap<>();
    claims.put("userId", loginUser.getUserId());
    claims.put("username", loginUser.getUsername());
    String token = jwtUtils.generateToken(claims);

    // æ­¥éª¤5: å­˜å‚¨åˆ°Redis
    loginUser.setToken(token);
    String redisKey = CommonConstant.LOGIN_USER_KEY + token;
    redisUtils.set(redisKey, loginUser, jwtUtils.getExpiration());

    // æ­¥éª¤6: æ›´æ–°ç”¨æˆ·ç™»å½•ä¿¡æ¯
    updateUserLoginInfo(loginUser.getUserId(), getRequestIp());

    // æ­¥éª¤7: è¿”å›ç™»å½•ç»“æœ
    return new LoginVO(token, userId, username, roles, permissions);
}
```

**è®¤è¯æµç¨‹å›¾**:
```
ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç 
    â†“
åˆ›å»ºUsernamePasswordAuthenticationToken
    â†“
AuthenticationManager.authenticate()
    â†“
DaoAuthenticationProvider
    â†“
UserDetailsService.loadUserByUsername()
    â†“
æŸ¥è¯¢æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
    â†“
PasswordEncoder.matches()éªŒè¯å¯†ç 
    â†“
è®¤è¯æˆåŠŸï¼Œè¿”å›Authenticationå¯¹è±¡
    â†“
ç”ŸæˆJWT Token
    â†“
å­˜å‚¨åˆ°Redis
    â†“
è¿”å›Tokenç»™å‰ç«¯
```

---

## 3. èµ„æºå¤šç±»å‹ç®¡ç†å®ç°

### 3.1 æ•°æ®åº“è®¾è®¡ï¼ˆç»§æ‰¿æ¨¡å¼ï¼‰

**è¡¨ç»“æ„**:
```
t_resourceï¼ˆä¸»è¡¨ï¼‰
    â”œâ”€â”€ id, resource_name, resource_type, status, ...
    â””â”€â”€ é€šç”¨å­—æ®µ

t_resource_simulationï¼ˆå­è¡¨ï¼šè™šæ‹Ÿä»¿çœŸï¼‰
    â”œâ”€â”€ id, resource_idï¼ˆå¤–é”®ï¼‰
    â””â”€â”€ simulation_url, technology, ...

t_resource_videoï¼ˆå­è¡¨ï¼šè§†é¢‘ï¼‰
    â”œâ”€â”€ id, resource_idï¼ˆå¤–é”®ï¼‰
    â””â”€â”€ video_url, duration, resolution, ...

t_resource_audioï¼ˆå­è¡¨ï¼šéŸ³é¢‘ï¼‰
    â”œâ”€â”€ id, resource_idï¼ˆå¤–é”®ï¼‰
    â””â”€â”€ audio_url, duration, format, ...

t_resource_documentï¼ˆå­è¡¨ï¼šæ–‡æ¡£ï¼‰
    â”œâ”€â”€ id, resource_idï¼ˆå¤–é”®ï¼‰
    â””â”€â”€ document_url, format, page_count, ...
```

**è®¾è®¡ä¼˜åŠ¿**:
1. **å•è¡¨å•è´£**: ä¸»è¡¨å­˜å‚¨é€šç”¨ä¿¡æ¯ï¼Œå­è¡¨å­˜å‚¨ç‰¹å®šä¿¡æ¯
2. **æ‰©å±•æ€§å¼º**: æ–°å¢èµ„æºç±»å‹åªéœ€æ·»åŠ æ–°å­è¡¨
3. **æŸ¥è¯¢çµæ´»**: å¯ä»¥åªæŸ¥ä¸»è¡¨ï¼ˆåˆ—è¡¨ï¼‰ï¼Œä¹Ÿå¯ä»¥è”æŸ¥ï¼ˆè¯¦æƒ…ï¼‰

### 3.2 åˆ›å»ºèµ„æºçš„å¤šæ€å®ç°

**æ–‡ä»¶ä½ç½®**: `backend/src/main/java/com/training/module/resource/service/impl/ResourceServiceImpl.java`

**æ ¸å¿ƒä»£ç **:

```java
@Override
@Transactional(rollbackFor = Exception.class)
public Long createResource(ResourceCreateDTO dto, Long uploaderId) {
    // 1. åˆ›å»ºèµ„æºåŸºç¡€ä¿¡æ¯
    Resource resource = new Resource();
    BeanUtil.copyProperties(dto, resource);
    resource.setUploaderId(uploaderId);
    resource.setStatus(0);  // å¾…å®¡æ ¸
    resourceMapper.insert(resource);

    // 2. æ ¹æ®èµ„æºç±»å‹åˆ›å»ºè¯¦æƒ…è®°å½•ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰
    Long resourceId = resource.getId();
    String resourceType = resource.getResourceType();

    switch (resourceType) {
        case "SIMULATION":
            createSimulationDetail(resourceId, dto.getSimulationDetail());
            break;
        case "VIDEO":
            createVideoDetail(resourceId, dto.getVideoDetail());
            break;
        case "AUDIO":
            createAudioDetail(resourceId, dto.getAudioDetail());
            break;
        case "DOCUMENT":
            createDocumentDetail(resourceId, dto.getDocumentDetail());
            break;
        default:
            throw new BusinessException("ä¸æ”¯æŒçš„èµ„æºç±»å‹: " + resourceType);
    }

    return resourceId;
}

/**
 * åˆ›å»ºè™šæ‹Ÿä»¿çœŸèµ„æºè¯¦æƒ…
 */
private void createSimulationDetail(Long resourceId, SimulationDetailDTO dto) {
    if (dto == null) {
        throw new BusinessException("ä»¿çœŸèµ„æºè¯¦æƒ…ä¸èƒ½ä¸ºç©º");
    }

    ResourceSimulation simulation = new ResourceSimulation();
    simulation.setResourceId(resourceId);
    BeanUtil.copyProperties(dto, simulation);
    simulationMapper.insert(simulation);
}

/**
 * åˆ›å»ºè§†é¢‘èµ„æºè¯¦æƒ…
 */
private void createVideoDetail(Long resourceId, VideoDetailDTO dto) {
    if (dto == null) {
        throw new BusinessException("è§†é¢‘èµ„æºè¯¦æƒ…ä¸èƒ½ä¸ºç©º");
    }

    ResourceVideo video = new ResourceVideo();
    video.setResourceId(resourceId);
    BeanUtil.copyProperties(dto, video);
    videoMapper.insert(video);
}

// å…¶ä»–ç±»å‹ç±»ä¼¼...
```

**æŠ€æœ¯è¦ç‚¹**:

**1. ç­–ç•¥æ¨¡å¼åº”ç”¨**:
```java
switch (resourceType) {
    case "SIMULATION": createSimulationDetail(...); break;
    case "VIDEO": createVideoDetail(...); break;
    // ...
}
```
- **ä¼˜åŠ¿**: ä¸åŒèµ„æºç±»å‹ä½¿ç”¨ä¸åŒå¤„ç†ç­–ç•¥
- **å¯æ‰©å±•**: æ–°å¢ç±»å‹åªéœ€æ·»åŠ caseåˆ†æ”¯

**æ›´ä¼˜é›…çš„å®ç°ï¼ˆç­–ç•¥æ¨¡å¼ + å·¥å‚æ¨¡å¼ï¼‰**:
```java
// å®šä¹‰ç­–ç•¥æ¥å£
interface ResourceDetailHandler {
    void createDetail(Long resourceId, Object dto);
}

// ä¸åŒç­–ç•¥å®ç°
@Component("SIMULATION")
class SimulationHandler implements ResourceDetailHandler {
    public void createDetail(Long resourceId, Object dto) {
        // å¤„ç†ä»¿çœŸèµ„æº
    }
}

@Component("VIDEO")
class VideoHandler implements ResourceDetailHandler {
    public void createDetail(Long resourceId, Object dto) {
        // å¤„ç†è§†é¢‘èµ„æº
    }
}

// ä½¿ç”¨å·¥å‚è·å–ç­–ç•¥
@Autowired
private Map<String, ResourceDetailHandler> handlerMap;

public Long createResource(ResourceCreateDTO dto) {
    // ...
    ResourceDetailHandler handler = handlerMap.get(resourceType);
    if (handler == null) {
        throw new BusinessException("ä¸æ”¯æŒçš„èµ„æºç±»å‹");
    }
    handler.createDetail(resourceId, dto.getDetail());
    // ...
}
```

**2. äº‹åŠ¡ç®¡ç†**:
```java
@Transactional(rollbackFor = Exception.class)
```
- **ä½œç”¨**: ä¿è¯ä¸»è¡¨å’Œå­è¡¨æ•°æ®ä¸€è‡´æ€§
- **å›æ»šæ¡ä»¶**: ä»»ä½•å¼‚å¸¸éƒ½å›æ»šï¼ˆåŒ…æ‹¬æ£€æŸ¥å¼‚å¸¸ï¼‰
- **åœºæ™¯**: å¦‚æœåˆ›å»ºå­è¡¨å¤±è´¥ï¼Œä¸»è¡¨è®°å½•ä¹Ÿä¼šå›æ»š

**3. DTOæ¨¡å¼**:
```java
public class ResourceCreateDTO {
    private String resourceName;
    private String resourceType;
    // é€šç”¨å­—æ®µ...

    private SimulationDetailDTO simulationDetail;
    private VideoDetailDTO videoDetail;
    // å…¶ä»–ç±»å‹çš„Detail...
}
```
- **ä¼˜åŠ¿**: å‰ç«¯åªéœ€å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ŒåŒ…å«ä¸»è¡¨å’Œå­è¡¨æ•°æ®
- **éªŒè¯**: å¯åœ¨DTOä¸Šæ·»åŠ `@Valid`æ³¨è§£è¿›è¡Œå‚æ•°éªŒè¯

### 3.3 æŸ¥è¯¢èµ„æºè¯¦æƒ…çš„å¤šæ€å®ç°

```java
@Override
public ResourceDetailVO getResourceById(Long id) {
    // 1. æŸ¥è¯¢èµ„æºåŸºç¡€ä¿¡æ¯
    Resource resource = resourceMapper.selectById(id);
    if (resource == null || resource.getIsDeleted() == 1) {
        throw new BusinessException("èµ„æºä¸å­˜åœ¨");
    }

    // 2. è½¬æ¢ä¸ºVO
    ResourceDetailVO detailVO = new ResourceDetailVO();
    BeanUtil.copyProperties(resource, detailVO);

    // è®¾ç½®ç±»å‹åç§°
    detailVO.setResourceTypeName(
        RESOURCE_TYPE_MAP.getOrDefault(resource.getResourceType(), "æœªçŸ¥")
    );

    // 3. æ ¹æ®ç±»å‹æŸ¥è¯¢è¯¦æƒ…ï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
    String resourceType = resource.getResourceType();
    switch (resourceType) {
        case "SIMULATION":
            ResourceSimulation simulation = simulationMapper.selectOne(
                new LambdaQueryWrapper<ResourceSimulation>()
                    .eq(ResourceSimulation::getResourceId, id)
            );
            if (simulation != null) {
                detailVO.setSimulationDetail(convertToSimulationVO(simulation));
            }
            break;

        case "VIDEO":
            ResourceVideo video = videoMapper.selectOne(
                new LambdaQueryWrapper<ResourceVideo>()
                    .eq(ResourceVideo::getResourceId, id)
            );
            if (video != null) {
                detailVO.setVideoDetail(convertToVideoVO(video));
            }
            break;

        // å…¶ä»–ç±»å‹ç±»ä¼¼...
    }

    // 4. æŸ¥è¯¢ä¸Šä¼ è€…ä¿¡æ¯
    if (resource.getUploaderId() != null) {
        User uploader = userMapper.selectById(resource.getUploaderId());
        if (uploader != null) {
            detailVO.setUploaderName(uploader.getRealName());
        }
    }

    return detailVO;
}
```

**æŠ€æœ¯è¦ç‚¹**:

**1. å»¶è¿ŸåŠ è½½**:
- å…ˆæŸ¥ä¸»è¡¨ï¼Œç¡®è®¤èµ„æºå­˜åœ¨
- å†æ ¹æ®ç±»å‹æŸ¥è¯¢å¯¹åº”çš„å­è¡¨
- **ä¼˜åŠ¿**: é¿å…æ— æ•ˆçš„å­è¡¨æŸ¥è¯¢

**2. ç±»å‹è½¬æ¢**:
```java
private SimulationVO convertToSimulationVO(ResourceSimulation simulation) {
    SimulationVO vo = new SimulationVO();
    BeanUtil.copyProperties(simulation, vo);
    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„å¤„ç†é€»è¾‘
    return vo;
}
```
- **ä½œç”¨**: å°†å®ä½“è½¬æ¢ä¸ºè§†å›¾å¯¹è±¡
- **å¥½å¤„**:
  - éšè—æ•æ„Ÿå­—æ®µ
  - æ·»åŠ è®¡ç®—å­—æ®µ
  - æ ¼å¼åŒ–æ•°æ®

**3. å…³è”æŸ¥è¯¢ä¼˜åŒ–**:
```java
// âŒ N+1æŸ¥è¯¢é—®é¢˜
List<Resource> resources = resourceMapper.selectList(...);
for (Resource r : resources) {
    User uploader = userMapper.selectById(r.getUploaderId());  // æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“
}

// âœ… æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
List<Resource> resources = resourceMapper.selectList(...);
Set<Long> uploaderIds = resources.stream()
    .map(Resource::getUploaderId)
    .collect(Collectors.toSet());

List<User> uploaders = userMapper.selectBatchIds(uploaderIds);  // ä¸€æ¬¡æŸ¥è¯¢
Map<Long, User> uploaderMap = uploaders.stream()
    .collect(Collectors.toMap(User::getId, u -> u));

for (Resource r : resources) {
    User uploader = uploaderMap.get(r.getUploaderId());
}
```

---

## 4. MyBatis-Plusé«˜çº§ç”¨æ³•

### 4.1 LambdaQueryWrapperç±»å‹å®‰å…¨æŸ¥è¯¢

**ä¼ ç»Ÿæ–¹å¼ï¼ˆå­—ç¬¦ä¸²å­—æ®µåï¼‰**:
```java
// âŒ æ˜“å‡ºé”™ï¼šå­—æ®µåå†™é”™æ— æ³•ç¼–è¯‘æ£€æŸ¥
QueryWrapper<User> wrapper = new QueryWrapper<>();
wrapper.eq("username", "admin");  // å¦‚æœå­—æ®µåå†™é”™ï¼Œè¿è¡Œæ—¶æ‰æŠ¥é”™
```

**Lambdaæ–¹å¼ï¼ˆç±»å‹å®‰å…¨ï¼‰**:
```java
// âœ… ç±»å‹å®‰å…¨ï¼šIDEè‡ªåŠ¨è¡¥å…¨ï¼Œç¼–è¯‘æœŸæ£€æŸ¥
LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
wrapper.eq(User::getUsername, "admin");  // å­—æ®µåé”™è¯¯ä¼šç¼–è¯‘æŠ¥é”™
```

**å¤æ‚æŸ¥è¯¢ç¤ºä¾‹**:
```java
LambdaQueryWrapper<News> wrapper = new LambdaQueryWrapper<>();
wrapper
    .eq(News::getIsDeleted, 0)                                    // æœªåˆ é™¤
    .eq(News::getStatus, 1)                                       // å·²å‘å¸ƒ
    .like(StringUtils.hasText(keyword), News::getTitle, keyword)  // æ ‡é¢˜æ¨¡ç³ŠæŸ¥è¯¢ï¼ˆæ¡ä»¶æŸ¥è¯¢ï¼‰
    .eq(StringUtils.hasText(category), News::getCategory, category)
    .orderByDesc(News::getIsTop)                                  // ç½®é¡¶ä¼˜å…ˆ
    .orderByDesc(News::getPublishTime);                           // å‘å¸ƒæ—¶é—´å€’åº

List<News> newsList = newsMapper.selectList(wrapper);
```

**æ¡ä»¶æŸ¥è¯¢æŠ€å·§**:
```java
// æ–¹å¼1ï¼šä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦
.like(keyword != null, News::getTitle, keyword)

// æ–¹å¼2ï¼šä½¿ç”¨Lambdaè¡¨è¾¾å¼
.like(StringUtils.hasText(keyword), News::getTitle, keyword)

// æ–¹å¼3ï¼šé“¾å¼è°ƒç”¨
.eq(status != null, News::getStatus, status)
.between(startTime != null && endTime != null,
         News::getPublishTime, startTime, endTime)
```

### 4.2 åˆ†é¡µæŸ¥è¯¢

**åŸºç¡€åˆ†é¡µ**:
```java
// åˆ›å»ºåˆ†é¡µå¯¹è±¡ï¼ˆç¬¬1é¡µï¼Œæ¯é¡µ10æ¡ï¼‰
Page<User> page = new Page<>(1, 10);

// æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
Page<User> userPage = userMapper.selectPage(page, wrapper);

// è·å–ç»“æœ
List<User> records = userPage.getRecords();    // å½“å‰é¡µæ•°æ®
long total = userPage.getTotal();              // æ€»è®°å½•æ•°
long pages = userPage.getPages();              // æ€»é¡µæ•°
```

**è‡ªå®šä¹‰SQLåˆ†é¡µ**:
```xml
<!-- Mapper XML -->
<select id="selectResourcePage" resultType="Resource">
    SELECT r.*, u.real_name as uploader_name
    FROM t_resource r
    LEFT JOIN t_user u ON r.uploader_id = u.id
    WHERE r.is_deleted = 0
    <if test="resourceType != null">
        AND r.resource_type = #{resourceType}
    </if>
    <if test="keyword != null">
        AND (r.resource_name LIKE CONCAT('%', #{keyword}, '%')
             OR r.description LIKE CONCAT('%', #{keyword}, '%'))
    </if>
    ORDER BY r.create_time DESC
</select>
```

```java
// Mapperæ¥å£
IPage<Resource> selectResourcePage(
    Page<Resource> page,
    @Param("resourceType") String resourceType,
    @Param("keyword") String keyword
);

// Serviceè°ƒç”¨
Page<Resource> page = new Page<>(pageNum, pageSize);
IPage<Resource> resourcePage = resourceMapper.selectResourcePage(
    page, resourceType, keyword
);
```

**åˆ†é¡µé…ç½®**:
```java
@Configuration
public class MyBatisConfig {
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        // æ·»åŠ åˆ†é¡µæ’ä»¶
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

### 4.3 è‡ªåŠ¨å¡«å……

**å®ä½“ç±»æ³¨è§£**:
```java
public class BaseEntity {
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;

    @TableField(fill = FieldFill.INSERT)
    private Long createBy;

    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Long updateBy;
}
```

**è‡ªåŠ¨å¡«å……å¤„ç†å™¨**:
```java
@Component
public class MyMetaObjectHandler implements MetaObjectHandler {

    @Override
    public void insertFill(MetaObject metaObject) {
        // æ–°å¢æ—¶è‡ªåŠ¨å¡«å……
        this.strictInsertFill(metaObject, "createTime", LocalDateTime.class, LocalDateTime.now());
        this.strictInsertFill(metaObject, "updateTime", LocalDateTime.class, LocalDateTime.now());

        // å¡«å……åˆ›å»ºäººï¼ˆä»SecurityContextè·å–ï¼‰
        Long userId = SecurityUtils.getUserId();
        if (userId != null) {
            this.strictInsertFill(metaObject, "createBy", Long.class, userId);
            this.strictInsertFill(metaObject, "updateBy", Long.class, userId);
        }
    }

    @Override
    public void updateFill(MetaObject metaObject) {
        // æ›´æ–°æ—¶è‡ªåŠ¨å¡«å……
        this.strictUpdateFill(metaObject, "updateTime", LocalDateTime.class, LocalDateTime.now());

        Long userId = SecurityUtils.getUserId();
        if (userId != null) {
            this.strictUpdateFill(metaObject, "updateBy", Long.class, userId);
        }
    }
}
```

**ä½¿ç”¨æ•ˆæœ**:
```java
// æ–°å¢ç”¨æˆ·
User user = new User();
user.setUsername("zhangsan");
user.setPassword("123456");
// æ— éœ€æ‰‹åŠ¨è®¾ç½®createTimeå’ŒupdateTime
userMapper.insert(user);

// æ’å…¥åï¼ŒcreateTimeå’ŒupdateTimeå·²è‡ªåŠ¨å¡«å……
System.out.println(user.getCreateTime());  // 2024-01-01 10:30:00
```

### 4.4 é€»è¾‘åˆ é™¤

**å®ä½“ç±»æ³¨è§£**:
```java
public class BaseEntity {
    @TableLogic
    private Integer isDeleted;  // 0-æœªåˆ é™¤ï¼Œ1-å·²åˆ é™¤
}
```

**é…ç½®**:
```yaml
mybatis-plus:
  global-config:
    db-config:
      logic-delete-field: isDeleted  # å…¨å±€é€»è¾‘åˆ é™¤å­—æ®µ
      logic-delete-value: 1          # åˆ é™¤å€¼
      logic-not-delete-value: 0      # æœªåˆ é™¤å€¼
```

**ä½¿ç”¨æ•ˆæœ**:
```java
// åˆ é™¤ç”¨æˆ·ï¼ˆé€»è¾‘åˆ é™¤ï¼‰
userMapper.deleteById(1);

// å®é™…æ‰§è¡Œçš„SQL
UPDATE t_user SET is_deleted = 1 WHERE id = 1

// æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤è®°å½•
List<User> users = userMapper.selectList(null);

// å®é™…æ‰§è¡Œçš„SQL
SELECT * FROM t_user WHERE is_deleted = 0
```

---

## 5. å‰ç«¯è¯·æ±‚æ‹¦æˆªå™¨è¯¦è§£

### 5.1 Axioså®ä¾‹åˆ›å»º

**æ–‡ä»¶ä½ç½®**: `frontend/src/utils/request.js`

```javascript
import axios from 'axios'
import { ElMessage, ElMessageBox } from 'element-plus'
import { useUserStore } from '@/store/modules/user'
import { getToken } from './auth'
import router from '@/router'

/**
 * åˆ›å»ºaxioså®ä¾‹
 */
const service = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',  // APIåŸºç¡€è·¯å¾„
  timeout: 15000,                                        // è¶…æ—¶æ—¶é—´15ç§’
  headers: {
    'Content-Type': 'application/json;charset=UTF-8'
  }
})
```

**é…ç½®è¯´æ˜**:
- **baseURL**: ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œæ”¯æŒå¼€å‘/ç”Ÿäº§ç¯å¢ƒåˆ‡æ¢
- **timeout**: è¶…æ—¶æ—¶é—´ï¼Œé¿å…è¯·æ±‚æ— é™ç­‰å¾…
- **headers**: é»˜è®¤è¯·æ±‚å¤´

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# .env.developmentï¼ˆå¼€å‘ç¯å¢ƒï¼‰
VITE_API_BASE_URL=http://localhost:8080/api

# .env.productionï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
VITE_API_BASE_URL=https://api.example.com
```

### 5.2 è¯·æ±‚æ‹¦æˆªå™¨

```javascript
/**
 * è¯·æ±‚æ‹¦æˆªå™¨
 */
service.interceptors.request.use(
  (config) => {
    // 1. æ·»åŠ Tokenåˆ°è¯·æ±‚å¤´
    const token = getToken()
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`
    }

    // 2. å¯ä»¥æ·»åŠ å…¶ä»–å…¬å…±è¯·æ±‚å¤´
    // config.headers['X-Requested-With'] = 'XMLHttpRequest'

    // 3. å¯ä»¥å¯¹è¯·æ±‚å‚æ•°è¿›è¡Œç»Ÿä¸€å¤„ç†
    // if (config.method === 'get') {
    //   config.params = { ...config.params, t: Date.now() }  // é˜²æ­¢ç¼“å­˜
    // }

    return config
  },
  (error) => {
    console.error('è¯·æ±‚é”™è¯¯:', error)
    return Promise.reject(error)
  }
)
```

**æŠ€æœ¯è¦ç‚¹**:

**1. Tokenè‡ªåŠ¨æ³¨å…¥**:
```javascript
config.headers['Authorization'] = `Bearer ${token}`
```
- æ¯ä¸ªè¯·æ±‚è‡ªåŠ¨æºå¸¦Token
- æ— éœ€åœ¨æ¯ä¸ªAPIè°ƒç”¨æ—¶æ‰‹åŠ¨æ·»åŠ 
- Tokenæ ¼å¼ï¼š`Bearer eyJhbGci...`

**2. è¯·æ±‚é…ç½®ä¿®æ”¹**:
```javascript
// å¯ä»¥ä¿®æ”¹ä»»ä½•è¯·æ±‚é…ç½®
config.headers['Custom-Header'] = 'value'
config.params = { ...config.params, extra: 'data' }
config.timeout = 30000  // å•ä¸ªè¯·æ±‚è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´
```

### 5.3 å“åº”æ‹¦æˆªå™¨

```javascript
/**
 * å“åº”æ‹¦æˆªå™¨
 */
service.interceptors.response.use(
  (response) => {
    const res = response.data

    // 1. å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼ˆæ–‡ä»¶ä¸‹è½½ï¼‰
    if (response.config.responseType === 'blob') {
      return response
    }

    // 2. æ ¹æ®ä¸šåŠ¡çŠ¶æ€ç åˆ¤æ–­
    if (res.code !== 200) {
      ElMessage.error(res.message || 'è¯·æ±‚å¤±è´¥')

      // 3. Tokenè¿‡æœŸå¤„ç†
      if (res.code === 401) {
        ElMessageBox.confirm(
          'ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œæ‚¨å¯ä»¥ç»§ç»­ç•™åœ¨è¯¥é¡µé¢ï¼Œæˆ–è€…é‡æ–°ç™»å½•',
          'ç³»ç»Ÿæç¤º',
          {
            confirmButtonText: 'é‡æ–°ç™»å½•',
            cancelButtonText: 'å–æ¶ˆ',
            type: 'warning'
          }
        ).then(() => {
          const userStore = useUserStore()
          userStore.resetState()
          router.push('/login')
        })
      }

      // 4. æƒé™ä¸è¶³å¤„ç†
      if (res.code === 403) {
        ElMessage.error('æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®è¯¥èµ„æº')
      }

      return Promise.reject(new Error(res.message || 'è¯·æ±‚å¤±è´¥'))
    }

    // 5. æˆåŠŸå“åº”ï¼Œè¿”å›dataéƒ¨åˆ†
    return res
  },
  (error) => {
    console.error('å“åº”é”™è¯¯:', error)

    let message = 'è¯·æ±‚å¤±è´¥'

    // 6. HTTPçŠ¶æ€ç é”™è¯¯å¤„ç†
    if (error.response) {
      switch (error.response.status) {
        case 400:
          message = 'è¯·æ±‚å‚æ•°é”™è¯¯'
          break
        case 401:
          message = 'æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•'
          const userStore = useUserStore()
          userStore.resetState()
          router.push('/login')
          break
        case 403:
          message = 'æƒé™ä¸è¶³'
          break
        case 404:
          message = 'è¯·æ±‚èµ„æºä¸å­˜åœ¨'
          break
        case 500:
          message = 'æœåŠ¡å™¨é”™è¯¯'
          break
        case 502:
          message = 'ç½‘å…³é”™è¯¯'
          break
        case 503:
          message = 'æœåŠ¡ä¸å¯ç”¨'
          break
        case 504:
          message = 'ç½‘å…³è¶…æ—¶'
          break
        default:
          message = error.response.data?.message || 'è¯·æ±‚å¤±è´¥'
      }
    } else if (error.message) {
      // 7. ç½‘ç»œé”™è¯¯å¤„ç†
      if (error.message.includes('timeout')) {
        message = 'è¯·æ±‚è¶…æ—¶'
      } else if (error.message.includes('Network Error')) {
        message = 'ç½‘ç»œé”™è¯¯'
      } else {
        message = error.message
      }
    }

    ElMessage.error(message)
    return Promise.reject(error)
  }
)

export default service
```

**æŠ€æœ¯è¦ç‚¹**:

**1. ä¸šåŠ¡çŠ¶æ€ç  vs HTTPçŠ¶æ€ç **:
```javascript
// ä¸šåŠ¡çŠ¶æ€ç ï¼ˆåç«¯è‡ªå®šä¹‰ï¼‰
res.code === 200    // ä¸šåŠ¡æˆåŠŸ
res.code === 401    // Tokenå¤±æ•ˆ
res.code === 403    // æƒé™ä¸è¶³
res.code === 500    // ä¸šåŠ¡å¼‚å¸¸

// HTTPçŠ¶æ€ç ï¼ˆHTTPåè®®æ ‡å‡†ï¼‰
response.status === 200   // HTTPè¯·æ±‚æˆåŠŸ
response.status === 404   // èµ„æºä¸å­˜åœ¨
response.status === 500   // æœåŠ¡å™¨é”™è¯¯
```

**2. é”™è¯¯å¤„ç†ä¼˜å…ˆçº§**:
```
ä¸šåŠ¡çŠ¶æ€ç é”™è¯¯ï¼ˆres.code !== 200ï¼‰
    â†“
HTTPçŠ¶æ€ç é”™è¯¯ï¼ˆerror.response.statusï¼‰
    â†“
ç½‘ç»œé”™è¯¯ï¼ˆerror.messageï¼‰
```

**3. æ–‡ä»¶ä¸‹è½½å¤„ç†**:
```javascript
// APIè°ƒç”¨
export function downloadFile(id) {
  return request({
    url: `/resource/${id}/download`,
    method: 'get',
    responseType: 'blob'  // æŒ‡å®šå“åº”ç±»å‹ä¸ºäºŒè¿›åˆ¶
  })
}

// ç»„ä»¶ä¸­ä½¿ç”¨
const handleDownload = async (id) => {
  try {
    const response = await downloadFile(id)
    // åˆ›å»ºBlobå¯¹è±¡
    const blob = new Blob([response.data])
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = 'æ–‡ä»¶å.pdf'
    link.click()
    window.URL.revokeObjectURL(url)
  } catch (error) {
    ElMessage.error('ä¸‹è½½å¤±è´¥')
  }
}
```

**4. Tokenåˆ·æ–°æœºåˆ¶**:
```javascript
// é«˜çº§å®ç°ï¼šTokenè‡ªåŠ¨åˆ·æ–°
let isRefreshing = false
let requests = []

service.interceptors.response.use(
  response => response,
  async error => {
    const { config, response } = error

    // Tokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°
    if (response.status === 401 && !config._retry) {
      if (!isRefreshing) {
        isRefreshing = true
        config._retry = true

        try {
          // è°ƒç”¨åˆ·æ–°Tokenæ¥å£
          const res = await refreshToken()
          const newToken = res.data.token
          setToken(newToken)

          // é‡è¯•æ‰€æœ‰pendingçš„è¯·æ±‚
          requests.forEach(cb => cb(newToken))
          requests = []

          // é‡è¯•å½“å‰è¯·æ±‚
          config.headers['Authorization'] = 'Bearer ' + newToken
          return service(config)
        } catch (e) {
          // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•
          router.push('/login')
        } finally {
          isRefreshing = false
        }
      } else {
        // æ­£åœ¨åˆ·æ–°ï¼Œå°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
        return new Promise(resolve => {
          requests.push(token => {
            config.headers['Authorization'] = 'Bearer ' + token
            resolve(service(config))
          })
        })
      }
    }

    return Promise.reject(error)
  }
)
```

---

## 6. æƒé™æ§åˆ¶å®ç°

### 6.1 åç«¯æƒé™æ§åˆ¶

**æ–¹æ³•çº§æƒé™æ³¨è§£**:
```java
@RestController
@RequestMapping("/v1/news")
public class NewsController {

    // åªæœ‰ADMINè§’è‰²å¯è®¿é—®
    @PreAuthorize("hasAuthority('ADMIN')")
    @DeleteMapping("/{id}")
    public Result<Void> deleteNews(@PathVariable Long id) {
        newsService.deleteNews(id);
        return Result.success();
    }

    // ADMINæˆ–æ‹¥æœ‰news:publishæƒé™çš„ç”¨æˆ·å¯è®¿é—®
    @PreAuthorize("hasAnyAuthority('news:publish', 'ADMIN')")
    @PutMapping("/{id}/publish")
    public Result<Void> publishNews(@PathVariable Long id) {
        newsService.publishNews(id);
        return Result.success();
    }

    // ä»»ä½•è®¤è¯ç”¨æˆ·éƒ½å¯è®¿é—®
    @GetMapping("/{id}")
    public Result<NewsDetailVO> getNewsById(@PathVariable Long id) {
        NewsDetailVO detail = newsService.getNewsById(id);
        return Result.success(detail);
    }
}
```

**SpELè¡¨è¾¾å¼æ”¯æŒ**:
```java
// å•ä¸ªæƒé™
@PreAuthorize("hasAuthority('user:edit')")

// å¤šä¸ªæƒé™ï¼ˆORå…³ç³»ï¼‰
@PreAuthorize("hasAnyAuthority('user:edit', 'ADMIN')")

// å¤šä¸ªæƒé™ï¼ˆANDå…³ç³»ï¼‰
@PreAuthorize("hasAuthority('user:edit') and hasAuthority('user:delete')")

// è§’è‰²åˆ¤æ–­
@PreAuthorize("hasRole('ADMIN')")

// å¤æ‚è¡¨è¾¾å¼
@PreAuthorize("hasRole('ADMIN') or (hasRole('TEACHER') and #userId == principal.userId)")

// è‡ªå®šä¹‰æ–¹æ³•è°ƒç”¨
@PreAuthorize("@permissionService.hasPermission('news:publish')")
```

**æƒé™åŠ è½½æµç¨‹**:
```java
// UserDetailsServiceImpl.java
@Override
public UserDetails loadUserByUsername(String username) {
    // 1. æŸ¥è¯¢ç”¨æˆ·
    User user = userMapper.selectOne(
        new LambdaQueryWrapper<User>()
            .eq(User::getUsername, username)
            .eq(User::getIsDeleted, 0)
    );

    // 2. æŸ¥è¯¢ç”¨æˆ·è§’è‰²
    List<String> roles = userRoleMapper.selectRolesByUserId(user.getId());

    // 3. æŸ¥è¯¢ç”¨æˆ·æƒé™
    List<String> permissions = rolePermissionMapper.selectPermissionsByUserId(user.getId());

    // 4. æ„å»ºLoginUserå¯¹è±¡
    LoginUser loginUser = new LoginUser();
    loginUser.setUserId(user.getId());
    loginUser.setUsername(user.getUsername());
    loginUser.setPassword(user.getPassword());
    loginUser.setRoles(roles);
    loginUser.setPermissions(permissions);

    return loginUser;
}
```

**æƒé™åˆ¤æ–­æµç¨‹**:
```
è¯·æ±‚åˆ°è¾¾
    â†“
JwtAuthenticationFilteréªŒè¯Token
    â†“
è®¾ç½®SecurityContext
    â†“
Controlleræ–¹æ³•æ‰§è¡Œå‰
    â†“
MethodSecurityInterceptoræ‹¦æˆª
    â†“
è§£æ@PreAuthorizeè¡¨è¾¾å¼
    â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€éœ€æƒé™
    â†“
å…è®¸è®¿é—® / æ‹’ç»è®¿é—®ï¼ˆ403ï¼‰
```

### 6.2 å‰ç«¯æƒé™æ§åˆ¶

**è·¯ç”±å®ˆå«**:
```javascript
// router/index.js
router.beforeEach(async (to, from, next) => {
  const userStore = useUserStore()

  // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯
  if (to.meta.requireAuth !== false) {
    const hasToken = userStore.token

    if (!hasToken) {
      // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
      next({ path: '/login', query: { redirect: to.fullPath } })
      return
    }

    // å·²ç™»å½•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯
    if (!userStore.userInfo) {
      try {
        await userStore.getUserInfo()
      } catch (error) {
        // è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼ŒTokenå¯èƒ½å¤±æ•ˆ
        userStore.resetState()
        next({ path: '/login', query: { redirect: to.fullPath } })
        return
      }
    }

    // æ£€æŸ¥è§’è‰²æƒé™
    if (to.meta.roles && to.meta.roles.length > 0) {
      const hasRole = to.meta.roles.some(role => userStore.hasRole(role))
      if (!hasRole) {
        ElMessage.error('æƒé™ä¸è¶³')
        next({ path: '/403' })
        return
      }
    }
  }

  next()
})
```

**æŒ‰é’®çº§æƒé™æ§åˆ¶**:
```vue
<template>
  <div>
    <!-- æ–¹å¼1ï¼šv-ifæŒ‡ä»¤ -->
    <el-button v-if="hasPermission('news:create')" @click="handleCreate">
      æ–°å»ºæ–°é—»
    </el-button>

    <!-- æ–¹å¼2ï¼šè‡ªå®šä¹‰æŒ‡ä»¤ -->
    <el-button v-permission="'news:edit'" @click="handleEdit">
      ç¼–è¾‘
    </el-button>

    <!-- æ–¹å¼3ï¼šè§’è‰²åˆ¤æ–­ -->
    <el-button v-if="isAdmin" @click="handleDelete">
      åˆ é™¤
    </el-button>
  </div>
</template>

<script setup>
import { useUserStore } from '@/store/modules/user'
import { computed } from 'vue'

const userStore = useUserStore()

// æƒé™åˆ¤æ–­æ–¹æ³•
const hasPermission = (permission) => {
  return userStore.hasPermission(permission)
}

// è§’è‰²åˆ¤æ–­
const isAdmin = computed(() => userStore.isAdmin())
</script>
```

**è‡ªå®šä¹‰æƒé™æŒ‡ä»¤**:
```javascript
// directives/permission.js
export default {
  mounted(el, binding) {
    const { value } = binding
    const userStore = useUserStore()

    if (value) {
      const hasPermission = userStore.hasPermission(value)
      if (!hasPermission) {
        // ç§»é™¤å…ƒç´ 
        el.parentNode && el.parentNode.removeChild(el)
      }
    } else {
      throw new Error('éœ€è¦æŒ‡å®šæƒé™ï¼å¦‚ v-permission="\'user:edit\'"')
    }
  }
}

// main.jsä¸­æ³¨å†Œ
import permission from './directives/permission'
app.directive('permission', permission)
```

---

## 7. åˆ†é¡µæŸ¥è¯¢æœ€ä½³å®è·µ

### 7.1 åç«¯åˆ†é¡µå®ç°

**Serviceå±‚**:
```java
@Override
public PageResult<UserVO> getUserPage(UserQueryDTO query) {
    // 1. åˆ›å»ºåˆ†é¡µå¯¹è±¡
    Page<User> page = new Page<>(query.getPageNum(), query.getPageSize());

    // 2. æ„å»ºæŸ¥è¯¢æ¡ä»¶
    LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(User::getIsDeleted, 0)
           .like(StringUtils.hasText(query.getKeyword()),
                 User::getUsername, query.getKeyword())
           .or()
           .like(StringUtils.hasText(query.getKeyword()),
                 User::getRealName, query.getKeyword())
           .eq(query.getStatus() != null, User::getStatus, query.getStatus())
           .orderByDesc(User::getCreateTime);

    // 3. æ‰§è¡Œåˆ†é¡µæŸ¥è¯¢
    Page<User> userPage = userMapper.selectPage(page, wrapper);

    // 4. è½¬æ¢ä¸ºVO
    List<UserVO> voList = userPage.getRecords().stream()
        .map(this::convertToVO)
        .collect(Collectors.toList());

    // 5. è¿”å›åˆ†é¡µç»“æœ
    return new PageResult<>(voList, userPage.getTotal());
}

private UserVO convertToVO(User user) {
    UserVO vo = new UserVO();
    BeanUtil.copyProperties(user, vo);
    // å¯†ç å­—æ®µä¸è¿”å›
    vo.setPassword(null);
    return vo;
}
```

**PageResultå°è£…**:
```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class PageResult<T> {
    private List<T> records;    // å½“å‰é¡µæ•°æ®
    private Long total;         // æ€»è®°å½•æ•°
    private Long pageNum;       // å½“å‰é¡µç 
    private Long pageSize;      // æ¯é¡µå¤§å°
    private Long pages;         // æ€»é¡µæ•°

    public PageResult(List<T> records, Long total) {
        this.records = records;
        this.total = total;
    }

    // ä»MyBatis-Plusçš„Pageå¯¹è±¡è½¬æ¢
    public static <T> PageResult<T> from(IPage<T> page) {
        return new PageResult<>(
            page.getRecords(),
            page.getTotal(),
            page.getCurrent(),
            page.getSize(),
            page.getPages()
        );
    }

    // è½¬æ¢æ•°æ®ç±»å‹
    public <R> PageResult<R> convert(List<R> records) {
        return new PageResult<>(
            records,
            this.total,
            this.pageNum,
            this.pageSize,
            this.pages
        );
    }
}
```

### 7.2 å‰ç«¯åˆ†é¡µå®ç°

**Vueç»„ä»¶**:
```vue
<template>
  <div>
    <!-- æœç´¢è¡¨å• -->
    <el-form :inline="true">
      <el-form-item label="å…³é”®è¯">
        <el-input v-model="queryParams.keyword" placeholder="è¯·è¾“å…¥å…³é”®è¯" />
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="handleSearch">æœç´¢</el-button>
        <el-button @click="handleReset">é‡ç½®</el-button>
      </el-form-item>
    </el-form>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <el-table :data="tableData" border>
      <el-table-column prop="username" label="ç”¨æˆ·å" />
      <el-table-column prop="realName" label="çœŸå®å§“å" />
      <el-table-column prop="createTime" label="åˆ›å»ºæ—¶é—´" />
    </el-table>

    <!-- åˆ†é¡µç»„ä»¶ -->
    <el-pagination
      v-model:current-page="queryParams.pageNum"
      v-model:page-size="queryParams.pageSize"
      :total="total"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handleCurrentChange"
    />
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { getUserPage } from '@/api/user'

// æŸ¥è¯¢å‚æ•°
const queryParams = reactive({
  pageNum: 1,
  pageSize: 10,
  keyword: ''
})

// è¡¨æ ¼æ•°æ®
const tableData = ref([])
const total = ref(0)
const loading = ref(false)

// åŠ è½½æ•°æ®
const loadData = async () => {
  loading.value = true
  try {
    const res = await getUserPage(queryParams)
    tableData.value = res.data.records
    total.value = res.data.total
  } catch (error) {
    ElMessage.error('åŠ è½½å¤±è´¥')
  } finally {
    loading.value = false
  }
}

// æœç´¢
const handleSearch = () => {
  queryParams.pageNum = 1  // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
  loadData()
}

// é‡ç½®
const handleReset = () => {
  queryParams.keyword = ''
  queryParams.pageNum = 1
  loadData()
}

// æ¯é¡µå¤§å°æ”¹å˜
const handleSizeChange = (size) => {
  queryParams.pageSize = size
  queryParams.pageNum = 1  // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
  loadData()
}

// å½“å‰é¡µæ”¹å˜
const handleCurrentChange = (page) => {
  queryParams.pageNum = page
  loadData()
}

// ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½æ•°æ®
onMounted(() => {
  loadData()
})
</script>
```

---

## 8. äº‹åŠ¡ç®¡ç†å’Œå¼‚å¸¸å¤„ç†

### 8.1 äº‹åŠ¡ç®¡ç†

**å£°æ˜å¼äº‹åŠ¡**:
```java
@Service
public class UserServiceImpl implements UserService {

    @Transactional(rollbackFor = Exception.class)
    public Long createUser(CreateUserDTO dto) {
        // 1. åˆ›å»ºç”¨æˆ·
        User user = new User();
        BeanUtil.copyProperties(dto, user);
        user.setPassword(passwordEncoder.encode(dto.getPassword()));
        userMapper.insert(user);

        // 2. åˆ›å»ºç”¨æˆ·æ‰©å±•ä¿¡æ¯
        UserProfile profile = new UserProfile();
        profile.setUserId(user.getId());
        profileMapper.insert(profile);

        // 3. ä¿å­˜ç”¨æˆ·è§’è‰²å…³è”
        if (dto.getRoleIds() != null) {
            saveUserRoles(user.getId(), dto.getRoleIds());
        }

        // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¼šå›æ»š
        return user.getId();
    }
}
```

**äº‹åŠ¡å±æ€§è¯¦è§£**:
```java
@Transactional(
    rollbackFor = Exception.class,      // å›æ»šå¼‚å¸¸ç±»å‹
    propagation = Propagation.REQUIRED,  // äº‹åŠ¡ä¼ æ’­è¡Œä¸º
    isolation = Isolation.DEFAULT,       // äº‹åŠ¡éš”ç¦»çº§åˆ«
    timeout = 30,                        // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    readOnly = false                     // æ˜¯å¦åªè¯»
)
```

**äº‹åŠ¡ä¼ æ’­è¡Œä¸º**:
```java
// REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åŠ å…¥è¯¥äº‹åŠ¡ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°äº‹åŠ¡
@Transactional(propagation = Propagation.REQUIRED)

// REQUIRES_NEWï¼šå§‹ç»ˆåˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
@Transactional(propagation = Propagation.REQUIRES_NEW)

// NESTEDï¼šå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åœ¨åµŒå¥—äº‹åŠ¡å†…æ‰§è¡Œ
@Transactional(propagation = Propagation.NESTED)
```

### 8.2 å…¨å±€å¼‚å¸¸å¤„ç†

**GlobalExceptionHandler**:
```java
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        log.error("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
        return Result.error(e.getMessage());
    }

    /**
     * å‚æ•°æ ¡éªŒå¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<Void> handleValidException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldErrors().stream()
            .map(FieldError::getDefaultMessage)
            .collect(Collectors.joining(", "));
        log.error("å‚æ•°æ ¡éªŒå¤±è´¥: {}", message);
        return Result.error(400, message);
    }

    /**
     * æƒé™ä¸è¶³å¼‚å¸¸
     */
    @ExceptionHandler(AccessDeniedException.class)
    public Result<Void> handleAccessDeniedException(AccessDeniedException e) {
        log.error("æƒé™ä¸è¶³: {}", e.getMessage());
        return Result.error(403, "æƒé™ä¸è¶³");
    }

    /**
     * æœªçŸ¥å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸: ", e);
        return Result.error("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
    }
}
```

**è‡ªå®šä¹‰ä¸šåŠ¡å¼‚å¸¸**:
```java
public class BusinessException extends RuntimeException {
    private Integer code;

    public BusinessException(String message) {
        super(message);
        this.code = 500;
    }

    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
    }
}

// ä½¿ç”¨
if (user == null) {
    throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-01-04
**ä½œè€…**: Training Team
