# æ•°æ®åº“å˜æ›´å¯¹æ¯”æ–‡æ¡£ï¼ˆç®€åŒ–ç‰ˆï¼‰

> **å˜æ›´æ—¥æœŸ**ï¼š2024-12-31
> **å˜æ›´ç±»å‹**ï¼šåŠŸèƒ½æ‰©å±•ï¼ˆæ— è¡¨ç»“æ„ä¿®æ”¹ï¼‰

---

## ğŸ“Š å¿«é€Ÿæ€»è§ˆ

| é¡¹ç›® | å˜æ›´æƒ…å†µ |
|------|---------|
| æ–°å¢è¡¨ | 0 |
| ä¿®æ”¹è¡¨ç»“æ„ | 0 |
| æ–°å¢å­—æ®µ | 0 |
| æ–°å¢ç´¢å¼• | 0 |
| æ–°å¢Mapper XML | 1 |
| æ–°å¢Mapperæ¥å£ | 3 |
| ä¿®æ”¹Javaç±» | 1 |

**ç»“è®ºï¼šâœ… æœ¬æ¬¡å®ç°å®Œå…¨åŸºäºç°æœ‰è¡¨ç»“æ„ï¼Œæ— éœ€æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼**

---

## ğŸ†• æ–°å¢æ–‡ä»¶æ¸…å•

### åç«¯ - Mapperå±‚

| æ–‡ä»¶ç±»å‹ | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|---------|------|
| XMLæ˜ å°„ | `backend/src/main/resources/mapper/UserRoleMapper.xml` | ç”¨æˆ·è§’è‰²æ‰¹é‡æ’å…¥SQL |
| Javaæ¥å£ | `backend/src/main/java/.../user/mapper/UserRoleMapper.java` | ç”¨æˆ·è§’è‰²å…³è”æ“ä½œ |
| Javaæ¥å£ | `backend/src/main/java/.../role/mapper/RoleMapper.java` | è§’è‰²æŸ¥è¯¢æ“ä½œ |
| Javaæ¥å£ | `backend/src/main/java/.../user/mapper/UserProfileMapper.java` | ç”¨æˆ·æ‰©å±•ä¿¡æ¯æ“ä½œ |

### åç«¯ - å®ä½“ç±»

| æ–‡ä»¶ç±»å‹ | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|---------|------|
| å®ä½“ç±» | `backend/src/main/java/.../role/entity/Role.java` | è§’è‰²å®ä½“ |
| å®ä½“ç±» | `backend/src/main/java/.../user/entity/UserRole.java` | ç”¨æˆ·è§’è‰²å…³è”å®ä½“ |

---

## ğŸ”„ ä¿®æ”¹çš„æ–‡ä»¶

### å…³é”®ä¿®æ”¹ï¼šLoginUser.java

**æ–‡ä»¶ï¼š** `backend/src/main/java/.../auth/dto/LoginUser.java`

**ä¿®æ”¹å†…å®¹ï¼š** `getAuthorities()` æ–¹æ³•

**å˜æ›´å¯¹æ¯”ï¼š**

```diff
  @Override
  public Collection<? extends GrantedAuthority> getAuthorities() {
-     // ä»…è¿”å›permissions
-     if (permissions != null && !permissions.isEmpty()) {
-         return permissions.stream()
-                 .map(SimpleGrantedAuthority::new)
-                 .collect(Collectors.toList());
-     }
-     return List.of();
+     // åŒæ—¶è¿”å›roleså’Œpermissions
+     Set<GrantedAuthority> authorities = new HashSet<>();
+
+     // æ·»åŠ è§’è‰²ï¼ˆè§’è‰²ä¹Ÿä½œä¸ºæƒé™ï¼‰
+     if (roles != null && !roles.isEmpty()) {
+         authorities.addAll(roles.stream()
+                 .map(SimpleGrantedAuthority::new)
+                 .collect(Collectors.toSet()));
+     }
+
+     // æ·»åŠ æƒé™
+     if (permissions != null && !permissions.isEmpty()) {
+         authorities.addAll(permissions.stream()
+                 .map(SimpleGrantedAuthority::new)
+                 .collect(Collectors.toSet()));
+     }
+
+     return authorities;
  }
```

**ä¿®æ”¹åŸå› ï¼š**
- åç«¯æ¥å£ä½¿ç”¨ `@PreAuthorize("hasAuthority('ADMIN')")`
- Spring Security éœ€è¦åœ¨æƒé™åˆ—è¡¨ä¸­æ‰¾åˆ° 'ADMIN' è§’è‰²
- åŸå®ç°åªè¿”å› permissionsï¼Œä¸åŒ…å« roles

---

## ğŸ—„ï¸ ä½¿ç”¨çš„æ•°æ®åº“è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰

| è¡¨å | ç”¨é€” | æœ¬æ¬¡æ“ä½œ |
|------|------|---------|
| `t_user` | ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ | SELECT, INSERT, UPDATE |
| `t_role` | è§’è‰²å®šä¹‰ | SELECT |
| `t_permission` | æƒé™å®šä¹‰ | SELECT |
| `t_user_role` | ç”¨æˆ·-è§’è‰²å…³è” | SELECT, INSERT, DELETE |
| `t_role_permission` | è§’è‰²-æƒé™å…³è” | SELECT |
| `t_user_profile` | ç”¨æˆ·æ‰©å±•ä¿¡æ¯ | SELECT, INSERT, UPDATE |
| `t_news` | æ–°é—»èµ„è®¯ | SELECT, INSERT, UPDATE, DELETE |

---

## ğŸ“ æ–°å¢çš„SQLæ“ä½œ

### UserRoleMapper.xml

**æ‰¹é‡æ’å…¥ç”¨æˆ·è§’è‰²å…³è”ï¼š**
```sql
INSERT INTO t_user_role (user_id, role_id, create_time, create_by)
VALUES
    (?, ?, ?, ?),
    (?, ?, ?, ?),
    ...
```

**ä½¿ç”¨åœºæ™¯ï¼š**
- ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·æ—¶æ‰¹é‡åˆ†é…å¤šä¸ªè§’è‰²
- ç®¡ç†å‘˜æ›´æ–°ç”¨æˆ·æ—¶é‡æ–°åˆ†é…è§’è‰²

---

## ğŸ¯ æ•°æ®åº“æ“ä½œæ€»ç»“

### ç”¨æˆ·ç®¡ç†åŠŸèƒ½

| æ“ä½œ | SQLç±»å‹ | æ¶‰åŠè¡¨ |
|------|---------|--------|
| æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ | SELECT | t_user, t_role, t_user_role |
| åˆ›å»ºç”¨æˆ· | INSERT | t_user, t_user_role |
| æ›´æ–°ç”¨æˆ· | UPDATE | t_user |
| æ›´æ–°è§’è‰² | DELETE + INSERT | t_user_role |
| åˆ é™¤ç”¨æˆ· | UPDATE (é€»è¾‘åˆ é™¤) | t_user |
| é‡ç½®å¯†ç  | UPDATE | t_user |
| æŸ¥è¯¢è§’è‰²åˆ—è¡¨ | SELECT | t_role |

### æ–°é—»ç®¡ç†åŠŸèƒ½

| æ“ä½œ | SQLç±»å‹ | æ¶‰åŠè¡¨ |
|------|---------|--------|
| æŸ¥è¯¢æ–°é—»åˆ—è¡¨ | SELECT | t_news |
| åˆ›å»ºæ–°é—» | INSERT | t_news |
| æ›´æ–°æ–°é—» | UPDATE | t_news |
| åˆ é™¤æ–°é—» | UPDATE (é€»è¾‘åˆ é™¤) | t_news |
| å‘å¸ƒæ–°é—» | UPDATE | t_news |
| æ’¤å›æ–°é—» | UPDATE | t_news |
| ç½®é¡¶æ–°é—» | UPDATE | t_news |

### ç”¨æˆ·ä¸­å¿ƒåŠŸèƒ½

| æ“ä½œ | SQLç±»å‹ | æ¶‰åŠè¡¨ |
|------|---------|--------|
| æŸ¥è¯¢ä¸ªäººä¿¡æ¯ | SELECT | t_user, t_role |
| æ›´æ–°ä¸ªäººä¿¡æ¯ | UPDATE | t_user |
| æŸ¥è¯¢æ‰©å±•ä¿¡æ¯ | SELECT | t_user_profile |
| æ›´æ–°æ‰©å±•ä¿¡æ¯ | INSERT/UPDATE | t_user_profile |
| ä¿®æ”¹å¯†ç  | UPDATE | t_user |
| ä¸Šä¼ å¤´åƒ | UPDATE | t_user |

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### æ•°æ®åº“å±‚é¢

- [x] **æ— éœ€æ‰§è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬**
- [x] ç¡®è®¤å·²æ‰§è¡Œ `schema.sql`ï¼ˆå»ºè¡¨è„šæœ¬ï¼‰
- [x] ç¡®è®¤å·²æ‰§è¡Œ `init_test_data.sql`ï¼ˆæµ‹è¯•æ•°æ®ï¼‰
- [x] ç¡®è®¤adminç”¨æˆ·æ‹¥æœ‰ADMINè§’è‰²

### åº”ç”¨å±‚é¢

- [x] æ–°å¢ `UserRoleMapper.xml` æ–‡ä»¶
- [x] ä¿®æ”¹ `LoginUser.java` çš„ `getAuthorities()` æ–¹æ³•
- [x] é‡å¯åç«¯åº”ç”¨æœåŠ¡å™¨
- [x] æ¸…é™¤æµè§ˆå™¨Cookieæˆ–é‡æ–°ç™»å½•

### éªŒè¯æ­¥éª¤

```sql
-- 1. éªŒè¯adminç”¨æˆ·è§’è‰²
SELECT u.username, r.role_code
FROM t_user u
INNER JOIN t_user_role ur ON u.id = ur.user_id
INNER JOIN t_role r ON ur.role_id = r.id
WHERE u.username = 'admin';

-- æœŸæœ›ç»“æœï¼š
-- username | role_code
-- admin    | ADMIN

-- 2. éªŒè¯è§’è‰²æ•°æ®
SELECT id, role_code, role_name FROM t_role;

-- æœŸæœ›ç»“æœï¼š
-- id | role_code | role_name
-- 1  | ADMIN     | è¶…çº§ç®¡ç†å‘˜
-- 2  | TEACHER   | æ•™å¸ˆ
-- 3  | STUDENT   | å­¦ç”Ÿ
```

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: ç®¡ç†å‘˜æ— æ³•è®¿é—®ç®¡ç†åŠŸèƒ½ï¼Œæç¤º"æƒé™ä¸è¶³"

**åŸå› ï¼š** æ—§Tokenä¸­æƒé™åˆ—è¡¨ä¸åŒ…å«è§’è‰²

**è§£å†³ï¼š**
1. é‡å¯åç«¯æœåŠ¡å™¨ï¼ˆåº”ç”¨ `LoginUser.java` ä¿®æ”¹ï¼‰
2. æ¸…é™¤æµè§ˆå™¨Cookieæˆ–é€€å‡ºç™»å½•
3. é‡æ–°ç™»å½•ç”Ÿæˆæ–°Token

### Q2: å¦‚ä½•ç¡®è®¤æ•°æ®åº“æ•°æ®æ­£ç¡®ï¼Ÿ

**æ‰§è¡ŒéªŒè¯SQLï¼š**
```sql
-- æŸ¥çœ‹adminç”¨æˆ·çš„å®Œæ•´æƒé™
SELECT
    u.username,
    r.role_code AS role,
    p.permission_code AS permission
FROM t_user u
LEFT JOIN t_user_role ur ON u.id = ur.user_id
LEFT JOIN t_role r ON ur.role_id = r.id
LEFT JOIN t_role_permission rp ON r.id = rp.role_id
LEFT JOIN t_permission p ON rp.permission_id = p.id
WHERE u.username = 'admin'
ORDER BY role, permission;
```

### Q3: æ‰¹é‡æ’å…¥ç”¨æˆ·è§’è‰²å¤±è´¥

**åŸå› ï¼š** `UserRoleMapper.xml` æ–‡ä»¶æœªåŠ è½½

**è§£å†³ï¼š**
1. æ£€æŸ¥æ–‡ä»¶è·¯å¾„ï¼š`backend/src/main/resources/mapper/UserRoleMapper.xml`
2. æ£€æŸ¥ `application.yml` é…ç½®ï¼š
   ```yaml
   mybatis-plus:
     mapper-locations: classpath*:/mapper/**/*.xml
   ```
3. é‡å¯åº”ç”¨æœåŠ¡å™¨

---

## ğŸ“ˆ æ€§èƒ½å½±å“è¯„ä¼°

| æ“ä½œ | æ€§èƒ½å½±å“ | è¯´æ˜ |
|------|---------|------|
| ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ | ä½ | ä½¿ç”¨ç´¢å¼•ï¼ŒJOINæŸ¥è¯¢ä¼˜åŒ– |
| æ‰¹é‡æ’å…¥è§’è‰² | ä½ | å•SQLæ‰¹é‡æ’å…¥ï¼Œæ€§èƒ½ä¼˜äºå¾ªç¯æ’å…¥ |
| æ–°é—»åˆ—è¡¨æŸ¥è¯¢ | ä½ | ä½¿ç”¨å¤åˆç´¢å¼• |
| æƒé™éªŒè¯ | æ—  | å†…å­˜æ“ä½œï¼Œæ— æ•°æ®åº“æŸ¥è¯¢ |

---

## ğŸ“¦ æ–‡ä»¶æ¸…å•

### æœ¬æ¬¡ç”Ÿæˆçš„æ–‡æ¡£

1. **æ•°æ®åº“å˜æ›´æ–‡æ¡£.md** - å®Œæ•´ç‰ˆæ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶çš„è¯¦ç»†ç‰ˆï¼‰
2. **æ•°æ®åº“å˜æ›´å¯¹æ¯”æ–‡æ¡£ï¼ˆç®€åŒ–ç‰ˆï¼‰.md** - æœ¬æ–‡ä»¶

---

## ğŸ¯ æ€»ç»“

### å˜æ›´äº®ç‚¹

âœ… **é›¶æ•°æ®åº“è¿ç§»** - æ— éœ€ä¿®æ”¹ä»»ä½•è¡¨ç»“æ„
âœ… **æœ€å°ä»£ç ä¾µå…¥** - ä»…æ–°å¢1ä¸ªXML + 3ä¸ªMapperæ¥å£
âœ… **å‘åå…¼å®¹** - ä¸å½±å“ç°æœ‰åŠŸèƒ½
âœ… **å³æ’å³ç”¨** - é‡å¯åº”ç”¨å³å¯ç”Ÿæ•ˆ

### é£é™©è¯„ä¼°

âš ï¸ **ä½é£é™©** - ä»…ä¿®æ”¹æƒé™è·å–é€»è¾‘ï¼Œä¸æ¶‰åŠæ•°æ®ç»“æ„å˜æ›´
âš ï¸ **éœ€é‡æ–°ç™»å½•** - ç”¨æˆ·éœ€æ¸…é™¤æ—§Tokené‡æ–°ç™»å½•
âš ï¸ **æ— æ•°æ®ä¸¢å¤±é£é™©** - æ‰€æœ‰æ“ä½œä½¿ç”¨é€»è¾‘åˆ é™¤

---

*æœ€åæ›´æ–°ï¼š2024-12-31*
